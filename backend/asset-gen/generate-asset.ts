import { JSONCompatible, Serializable } from "src/db.ts";
import createId from "src/utils/createId.ts";
import { toIsoStringWithTimezone } from "src/utils/date.ts";

type Dimensions = {
  width: number; // x-axis
  height: number; // y-axis
};

export type AssetJSON = {
  id: string;
  name: string;
  date: string;
  description: string;
  type: string;
  remoteImages: RemoteImage[];
  dimensions: Dimensions;
};

export class Asset implements Serializable {
  private readonly _id: string;
  public name: string;
  public type: string;
  public description: string;
  public readonly date: Date;
  // Array of URLs to image in object storage, in order of processing
  // First image is the original image generated by OpenAI
  // Last image is the final image after all
  private readonly remoteImages: RemoteImage[];
  public dimensions: Dimensions;

  constructor(
    description: string,
    type: string,
    date: Date = new Date(),
    id: string = createId(),
    remoteImages: RemoteImage[] = [],
    dimensions: Dimensions = { width: 0, height: 0 },
    name?: string
  ) {
    this.description = description;
    this.type = type;
    this.date = date;
    this._id = id;
    this.remoteImages = remoteImages;
    this.name = name ?? this._id;
  }

  getFilename(): string {
    return `${this.name}.${this.type}`;
  }

  addRemoteImage(namedRemoteObject: RemoteImage) {
    this.remoteImages.push(namedRemoteObject);
  }

  getRemoteImages(): RemoteImage[] {
    return this.remoteImages;
  }

  serialize(): JSONCompatible<AssetJSON> {
    return {
      id: this._id,
      name: this.name,
      date: toIsoStringWithTimezone(this.date),
      description: this.description,
      type: this.type,
      remoteImages: this.remoteImages,
      dimensions: this.dimensions,
    };
  }

  static deserialize(obj: AssetJSON): Asset {
    return new Asset(
      obj.description,
      obj.type,
      new Date(obj.date),
      obj.id,
      obj.remoteImages,
      obj.dimensions,
      obj.name
    );
  }
}

class RemoteImage {
  constructor(public name: string, public url: string) {}
}
